{
    "contents" : "library(shinydashboard)\nsource(\"helpers.R\")\nlibrary(ggplot2)\nlibrary(rjson)\nlibrary(riigiteenused)\nlibrary(curl) #shiny server nõuab seda\n\n#andmed=readRDS(\"./andmed/2016-02-05_andmedPikk.rds\")\n# andmed sisse, pikaks ja minni nimedest haldusala maha\nandmedLai=riigiteenused::andmedSisse(\"https://www.riigiteenused.ee/api/et/all\")\nandmed=andmedPikaks(andmedLai)\nandmed$ministeerium=gsub(\"i haldusala\", \"\", andmed$ministeerium)\nandmed$kanal=gsub(\"Kliendijuures\", \"Kliendi juures\", andmed$kanal)\nandmed$kanal=gsub(\"Eiseteenindus\", \"E-iseteenindus\", andmed$kanal)\nandmed$kanal=gsub(\"Epost\", \"E-post\", andmed$kanal)\nandmed$naitaja=gsub(\"osutamistearv\", \"osutamiste arv\", andmed$naitaja)\n#kuupäeva ja kellaaja kuvamiseks\nvalues <- reactiveValues()\n\nserver <- function(input, output, session) {\n  #kustutab \"laeb\" teksti, kui andmed on sisse loetud\n  hide(id = \"loading-content\", anim = TRUE, animType = \"fade\")\n  \n  #kuupäeva ja kellaaja kuvamiseks\n  isolate(values$time <- Sys.time())\n    output$time <- renderText({\n      paste(\"Andmed on seisuga\", as.character(values$time+7200), \"EET\") \n      #liidan, et selleks et shiny server kuvaks Eesti aja järgi\n  })\n  \n  #######KUSTUTAMISEKS vaja ainult andmete rakendusest alla laadimiseks\n#     output$downloadData <- downloadHandler(\n#       filename = \"andmed.csv\",\n#       content = function(file) {\n#         write.table(andmed, file, sep=\";\")\n#       }\n#     )\n#     output$downloadData2 <- downloadHandler(\n#       filename = \"andmedLai.csv\",\n#       content = function(file) {\n#         write.table(andmedLai[, 1:9], file, sep=\";\")\n#       }\n#     )\n  #############\n    \n  ########üldise vaate asjad\n  #ministeeriumite arv üldine\n  output$MinArv <- renderValueBox({\n    ########kui joonistab graafikuid, siis kuvab selle teate\n    progress <- shiny::Progress$new(session, min=0, max=1)\n        on.exit(progress$close())\n        progress$set(message = 'Joonistan graafikuid',\n                     detail = 'Palun oota ...')\n        #################################\n        valueBox(\n          paste(paste(length(unique(andmed$ministeerium)))), \n          \"ministeeriumi\",icon = icon(\"institution\"),color = \"purple\")\n  })\n  #allasutuste arv üldine\n  output$AsutusteArv <- renderValueBox({\n    valueBox(paste(length(unique(andmed$allasutus))), \n             \"allasutust\",icon = icon(\"home\"),color = \"purple\" )\n  })\n  #teenuste arv üldine\n  output$TeenusteArv <- renderValueBox({\n    TeenusteSum(andmed=andmed, minJah=2)\n  })\n  # plot teenuseid kanalis üldine\n  output$TeenuseidKanalis <- renderPlot({\n    data <- summeerija2(andmed[andmed$naitaja==\"rahulolu\",], c(\"kanal\", \"identifikaator\", \"naitaja\"))\n    visualiseerija2(data, aes(x=kanal, y=arv),\"\")\n  })\n  # plot moodikuid kanali kohta üldine\n  output$Moodikuid <- renderPlot({\n    #     ########kui joonistab graafikuid, siis kuvab selle teate\n    progress <- shiny::Progress$new(session, min=0, max=1)\n    on.exit(progress$close())\n    \n    progress$set(message = 'Joonistan graafikuid',\n                 detail = 'Palun oota ...')\n    #################################\n    data <- summeerija(andmed, c(\"naitaja\"))\n    visualiseerija(data, aes(x=naitaja, y=stat_olemas_pr, label=stat_olemas_tk), \"\")\n    #visualiseerija(data, aes(x=naitaja, y=stat_olemas_tk), \"\")\n    \n    })\n  #üldine kasutuskordade arv kokku\n  output$Kasutuskordi <- renderValueBox({\n    KasutuskordadeSum(andmed=andmed, minist=input$ministeerium, minJah=2)\n  })\n  #üldine keskmine rahulolu\n  output$Rahulolu <- renderValueBox({\n    KeskmineRahulolu(andmed=andmed, minist=input$ministeerium, minJah=2)\n  })\n  #üldine teenuste maksumus\n  output$Maksumus <- renderValueBox({\n    HalduskuluSum(andmed=andmed, minist=input$ministeerium, minJah=2)\n  })\n  #üldine teenuste ajakulu\n  output$Ajakulu <- renderValueBox({\n    KliendiAjakuluSum(andmed=andmed, minist=input$ministeerium, minJah=2)\n  })\n  ##########ministeeriumi vaate asjad\n  #ministeeriumite nimekiri dropdowni\n  output$ministeerium <- renderUI({\n    selectInput(\"ministeerium\", \"\", as.character(unique(andmed$ministeerium)))\n  })\n  #ministeeriumi teenuste arv\n  output$MinTeenusteArv <- renderValueBox({\n      TeenusteSum(andmed=andmed, minist=input$ministeerium, minJah=1)\n  })\n  #asutuste arv ministeeriumi haldusalas\n  output$MinAsutusteArv <- renderValueBox({\n    valueBox(\n      paste(length(unique(andmed[andmed$ministeerium==input$ministeerium,]$allasutus))), \n      \"allasutust\",icon = icon(\"home\"),color = \"purple\")\n  })\n  #plot ministeeriumi teenuseid kanali kohta\n  output$TeenuseidKanalisMin <- renderPlot({\n    data <- summeerija2(andmed[andmed$ministeerium==input$ministeerium&andmed$naitaja==\"rahulolu\",], c(\"kanal\", \"identifikaator\", \"naitaja\"))\n    visualiseerija2(data, aes(x=kanal, y=arv),\"\")\n  })\n  # plot ministeeriumi moodikuid kanali kohta\n  output$MoodikuidMin <- renderPlot({\n    #     ########kui joonistab graafikuid, siis kuvab selle teate\n    progress <- shiny::Progress$new(session, min=0, max=1)\n    on.exit(progress$close())\n    \n    progress$set(message = 'Joonistan graafikuid',\n                 detail = 'Palun oota ...')\n    #################################\n    data <- summeerija(andmed[andmed$ministeerium==input$ministeerium,], c(\"naitaja\"))\n    #visualiseerija(data, aes(x=naitaja, y=stat_olemas_pr), \"\")\n    visualiseerija(data, aes(x=naitaja, y=stat_olemas_pr, label=stat_olemas_tk), \"\")\n    \n  })\n  #ministeeriumi kasutuskordade arv kokku\n  output$MinKasutuskordi <- renderValueBox({\n    KasutuskordadeSum(andmed=andmed, minist=input$ministeerium, minJah=1)\n  })\n  #minsteeriumi keskmine rahulolu\n  output$MinRahulolu <- renderValueBox({\n    KeskmineRahulolu(andmed=andmed, minist=input$ministeerium, minJah=1)\n  })\n  #ministeeriumi teenuste maksumus\n  output$MinMaksumus <- renderValueBox({\n    HalduskuluSum(andmed=andmed, minist=input$ministeerium, minJah=1)\n  })\n  #ministeeriumi teenuste ajakulu\n  output$MinAjakulu <- renderValueBox({\n    ########kui joonistab graafikuid, siis kuvab selle teate\n    progress <- shiny::Progress$new(session, min=0, max=1)\n    on.exit(progress$close())\n    \n    progress$set(message = 'Joonistan graafikuid',\n                 detail = 'Palun oota ...')\n    #################################\n    KliendiAjakuluSum(andmed=andmed, minist=input$ministeerium, minJah=1)\n  })\n  \n  ############################allasutuste asjad\n  ##interaktiivselt kuvab minnide nimed dropdownis\n  output$ministeerium2 <- renderUI({\n    selectInput(\"ministeerium2\", \"\", as.character(unique(andmed$ministeerium)))\n  })\n  ##interaktiivselt kuvab asutused, mis valitud minni al on\n  output$allasutus <- renderUI({\n    selectInput(\"asutus\", \"\", as.character(unique(andmed[andmed$ministeerium==input$ministeerium2,]$allasutus)))\n  })\n  #allasutuse teenuste arv\n  output$AsutTeenusteArv <- renderValueBox({\n    #plot teenuseid kanalis \n    TeenusteSum(andmed=andmed, allasutus =input$asutus, minJah=0)\n  })\n  output$TeenuseidKanalisAsut <- renderPlot({\n    data <- summeerija2(andmed[andmed$allasutus==input$asutus&andmed$naitaja==\"rahulolu\",], c(\"kanal\", \"identifikaator\", \"naitaja\"))\n    visualiseerija2(data, aes(x=kanal, y=arv),\"\")\n  })\n  # plot asutuse moodikuid kanali kohta\n  output$MoodikuidAsut <- renderPlot({\n    data <- summeerija(andmed[andmed$allasutus==input$asutus,], c(\"naitaja\"))\n    visualiseerija(data, aes(x=naitaja, y=stat_olemas_pr, label=stat_olemas_tk), \"\")\n    #visualiseerija(data, aes(x=naitaja, y=stat_olemas_pr), \"\")\n  })\n  #asutuse kasutuskordade arv kokku\n  output$AsutKasutuskordi <- renderValueBox({\n    KasutuskordadeSum(andmed=andmed, allasutus=input$asutus, minJah=0)\n  })\n  #asutuse keskmine rahulolu\n  output$AsutRahulolu <- renderValueBox({\n    KeskmineRahulolu(andmed=andmed, allasutus=input$asutus, minJah=0)\n  })\n  #asutuse teenuste maksumus\n  output$AsutMaksumus <- renderValueBox({\n    HalduskuluSum(andmed=andmed, allasutus=input$asutus, minJah=0)\n  })\n  #asutuse teenuste ajakulu\n  output$AsutAjakulu <- renderValueBox({\n    #     ########kui joonistab graafikuid, siis kuvab selle teate\n    progress <- shiny::Progress$new(session, min=0, max=1)\n    on.exit(progress$close())\n    \n    progress$set(message = 'Joonistan graafikuid',\n                 detail = 'Palun oota ...')\n    #################################\n    KliendiAjakuluSum(andmed=andmed, allasutus=input$asutus, minJah=0)\n  })\n}\n\n\n",
    "created" : 1448807178136.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "408973333",
    "id" : "A6CA510A",
    "lastKnownWriteTime" : 1454937409,
    "path" : "~/R/Riigiteenused_shiny/server.R",
    "project_path" : "server.R",
    "properties" : {
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "type" : "r_source"
}