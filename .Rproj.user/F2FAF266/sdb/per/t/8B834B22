{
    "contents" : "#########Igasugu abifunktsioone\n##meltimine data.tabeliga, teeb laiast pika vormingu, abifunk korrastajale\nmeltimineDT=function(kanal, data) {\n  sub=data[,grepl(paste(kanal, \"|identifikaator|ministeerium|allasutus|tegevusvaldkond|teenusetyyp|makse\", sep=\"\"), \n                  names(data)), with=F]\n\n  id=grep(c(\"identifikaator|ministeerium|allasutus|tegevusvaldkond|teenusetyyp|makse|link\"), names(sub), value=T)\n  if(length(id)<7) {\n    tulem=NULL\n  } else {\n    #meldime andmed kitsaks\n    tulem=melt(sub, id=id)\n    #muudan variable nime ära, mis on kanalispets, muidu ei saa rbindida\n    lingiNimi=names(tulem)[7]\n    setnames(tulem, old=lingiNimi, new=c(\"link\"))\n  }\n  tulem\n}\n##teeb laiast pika\nkorrastajaDT=function(andmed, eemalda, mootmiseAasta) {\n  library(data.table)\n  #eemalda - mis osa columnite nimedest tuleb eemdalda\n  setnames(andmed, names(andmed), gsub(eemalda, \"\", names(andmed)))\n  #kanalite lõikes meldime\n  veeb=meltimineDT(\"Veebileht / portaal.\", data=andmed)\n  iseteen=meltimineDT(\"E-iseteenindus.\", data=andmed)\n  eesti=meltimineDT(\"Eesti.ee.\", data=andmed)\n  nuti=meltimineDT(\"Nutirakendus.\", data=andmed)\n  digitv=meltimineDT(\"Digitelevisioon.\", data=andmed)\n  epost=meltimineDT(\"E-post.\", data=andmed)\n  sms=meltimineDT(\"Tekstisõnum.\", data=andmed)\n  telefon=meltimineDT(\"Telefon.\", data=andmed)\n  faks=meltimineDT(\"Faks.\", data=andmed)\n  post=meltimineDT(\"Post.\", data=andmed)\n  lett=meltimineDT(\"Letiteenus.\", data=andmed) \n  kodus=meltimineDT(\"Kliendi juures.\", data=andmed)\n  \n  #rbindime\n  koos=rbindlist(list(veeb, iseteen, eesti, nuti, digitv, epost, sms, telefon, faks, \n                      post, lett, kodus))\n\n  #eemaldame kanali ja näitaja ning paneme eraldi veergu\n  if (length(koos)==0) {\n    return(NULL)\n  } else {\n    koos[,variable:=gsub(\".ee.\", \".\", as.character(koos[,variable]), fixed=T)]\n    koos[,variable:=gsub(\"Letiteenus büroos\", \"Letiteenus\", as.character(koos[,variable]), fixed=T)]\n    koos[,variable:=gsub(\"E-iseteenindus\", \"Eiseteenindus\", as.character(koos[,variable]), fixed=T)]\n    koos[,variable:=gsub(\"E-post\", \"Epost\", as.character(koos[,variable]), fixed=T)]\n    koos[,variable:=gsub(\"Veebileht / portaal\", \"Veebileht\", as.character(koos[,variable]), fixed=T)]\n    koos[,variable:=gsub(\"Kliendi juures\", \"Kliendijuures\", as.character(koos[,variable]), fixed=T)]\n    \n    koos[, c(\"kanal\", \"naitaja\") := tstrsplit(as.character(koos[[\"variable\"]]), \"\\\\.(?=[^\\\\.]+$)\", perl=T)]\n    koos[,kanal:=gsub(\"^.*\\\\.\", \"\", koos[, kanal])]\n    #viskame välja tühjad read, kus pole linki\n    koos=koos[link!=\"NA\"]\n    koos[,MootmiseAasta:=mootmiseAasta]\n    koos\n  }\n}\n##kogu eelneva seob üheks funktsiooniks, vaja muuta, kui aastaid tuleb rohkem\nandmedPikaksDT=function(andmedLai) {\n  library(data.table)\n  andmed=data.table(andmedLai)\n  andmedLai2015=andmed[, !grepl(\"empty.|2011.|2013.|2012.|2014.\", \n                                names(andmed)), with=F]\n  andmedLai2014=andmed[, !grepl(\"empty.|2011.|2013.|2012.|2015.\",\n                                names(andmed)), with=F]\n  andmedLai2013=andmed[, !grepl(\"empty.|2011.|2012.|2014.|2015.\",\n                                names(andmed)), with=F]\n  andmedLai2012=andmed[, !grepl(\"empty.|2011.|2013.|2014.|2015.\",\n                                names(andmed)), with=F]\n  andmedLai2011=andmed[, !grepl(\"empty.|2014.|2013.|2012.|2015.\",\n                                names(andmed)), with=F]\n  andmedLaiEmpty=andmed[, !grepl(\"2014.|2011.|2013.|2012.|2015.\",\n                                names(andmed)), with=F]\n  \n  puhas2015=korrastajaDT(andmedLai2015, \"2015.\", \"2015\")\n  puhas2014=korrastajaDT(andmedLai2014, \"2014.\", \"2014\")\n  puhas2013=korrastajaDT(andmedLai2013, \"2013.\", \"2013\")\n  puhas2012=korrastajaDT(andmedLai2012, \"2012.\", \"2012\")\n  puhas2011=korrastajaDT(andmedLai2011, \"2011.\", \"2011\")\n  puhasEmpty=korrastajaDT(andmedLaiEmpty, \"empty.\", \"pole moodetud\")\n  andmedPikk=rbind(puhas2015, puhas2014, puhas2013, puhas2012,puhas2011,\n                   puhasEmpty)\n  andmedPikk[, value:=as.numeric(as.character(value))]\n}\n\n#############Statistika, graafika funktsioonid\n\n#abifunktsioon andmete summeerimiseks\nsummeerija=function(data, ...) { #... paned jutumärkidesse variabled mille järgi grupeerida\n  library(dplyr)\n  tulem=data %>%\n    group_by_(...) %>%\n    summarize(stat_olemas_tk=sum(!is.na(value)),\n              max_stat=length(value), #ehk kui palju oleks kanali näitaja hulk\n              stat_olemas_pr=sum(!is.na(value))/length(value)) \n  tulem\n}\n\n#ja eelneva funktsiooni andmete visualiseerimiseks (skaala %)\nvisualiseerija=function(data, mapping, ylab, ymax, title) {\n  #teljepikkus=max(data$max_stat)#y-telje kõrgus\n  #localenv <- environment()\n  library(ggplot2)\n  library(scales)\n  ggplot(data, mapping)+\n    geom_bar(stat = \"identity\", fill=\"lightblue\")+\n    theme_minimal()+\n    theme(axis.text.x = element_text(angle = 45, hjust=1, size=13))+\n    xlab(\"\")+\n    ylab(ylab)+\n    coord_cartesian(ylim=c(0,1))+\n    #coord_cartesian(ylim=c(0,teljepikkus), expand=F)+\n    geom_text(nudge_y=0.05)+\n    #scale_y_discrete(labels = percent)+\n    #ggtitle(\"Mõõdikutega kanalite osakaal ja arv:\")\n    ggtitle(title)\n}\n\n\n#summeerija, ei tooda protsente\nsummeerija2=function(data, ...) { #... paned jutumärkidesse variabled mille järgi grupeerida\n  library(dplyr)\n  tulem=data %>%\n    group_by_(...) %>%\n    summarize(arv=n()) \n  tulem\n}\n#ja eelneva andmete alusel graafiku tegemiseks\nvisualiseerija2=function(data, mapping, ylab, title) {\n  library(ggplot2)\n  ggplot(data, mapping)+\n    geom_bar(stat = \"identity\", fill=\"lightblue\")+\n    theme_minimal()+\n    theme(axis.text.x = element_text(angle = 45, hjust=1, size=13))+\n    xlab(\"\")+\n    ylab(ylab)+\n    #ggtitle(enc2native(\"Teenuste arv kanalite lõikes\"))\n    ggtitle(enc2native(title))\n}\n#teenuste arv minni/asutuse haldusalas, teeb valueboxi interface\nTeenusteSum=function(andmed, minist, allasutusnimi, minJah, text, keel) {\n  if (keel==\"et\") {\n    if (minJah==1) { #kui muu, siis on allasutus\n      andmed=andmed[andmed$ministeerium==minist,]\n    } else if (minJah==2) {\n      andmed=andmed\n    } else    {\n     # andmed=andmed[andmed$allasutus==allasutus,]\n      andmed=andmed[allasutus==allasutusnimi]\n    }\n    valueBox(\n      paste(length(unique(andmed$identifikaator))), \n      text,icon = icon(\"list-ol\"),color = \"purple\")\n  } else {\n    if (minJah==1) { #kui muu, siis on allasutus\n      andmed=andmed[andmed$ministeerium_en==minist,]\n    } else if (minJah==2) {\n      andmed=andmed\n    } else    {\n      #andmed=andmed[andmed$allasutus_en==allasutus,]\n      andmed=andmed[allasutus_en==allasutusnimi]\n    }\n    valueBox(\n      paste(length(unique(andmed$identifikaator))), \n      text,icon = icon(\"list-ol\"),color = \"purple\")\n  }\n}\n\n#kasutuskordade summa arvutamiseks, teeb vale boxi interface\nKasutuskordadeSum=function(andmed, minist, allasutusnimi, minJah, text, keel) {\n  if (keel==\"et\") {\n    if (minJah==1) { #kui muu, siis on allasutus\n      andmed=andmed[andmed$ministeerium==minist,]\n    } else if (minJah==2) {\n      andmed=andmed\n    }else if (minJah==0) {\n      #andmed=andmed[andmed$allasutus==allasutus,]\n      andmed=andmed[allasutus==allasutusnimi]\n    }\n    valueBox(\n      paste(format(sum(andmed[andmed$naitaja==\"osutamiste arv\",]$value, na.rm = T), big.mark=\" \")), \n      text,icon = icon(\"hand-o-left\"),color = \"purple\")\n  } else if (keel==\"en\") {\n    if (minJah==1) { #kui muu, siis on allasutus\n      andmed=andmed[andmed$ministeerium_en==minist,]\n    } else if (minJah==2) {\n      andmed=andmed\n    }else {\n      #andmed=andmed[andmed$allasutus_en==allasutus,]\n      andmed=andmed[allasutus_en==allasutusnimi]\n    }\n    valueBox(\n      paste(format(sum(andmed[andmed$naitaja==\"osutamiste arv\",]$value, na.rm = T), big.mark=\" \")), \n      text,icon = icon(\"hand-o-left\"),color = \"purple\")\n  }\n}\n\n#keskmise rahulolu arvutamiseks, teeb value boxi kohe interfaces\nKeskmineRahulolu=function(andmed, minist, allasutusnimi, minJah, text, keel) {\n  if (keel==\"et\") {\n    if (minJah==1) { #kui muu, siis on allasutus\n      andmed=andmed[andmed$ministeerium==minist,]\n    } else if (minJah==2) {\n      andmed=andmed\n    }else {\n      #andmed=andmed[andmed$allasutus==allasutus,]\n      andmed=andmed[allasutus==allasutusnimi]\n    }\n    valueBox(\n      paste(round(\n        mean(\n          andmed[andmed$naitaja==\"rahulolu\",]$value, na.rm = T), 1)) \n      ,paste(\"%\", text),icon = icon(\"smile-o\"),color = \"purple\")\n  } else {#kui on inglise keel\n    if (minJah==1) { #kui muu, siis on allasutus\n      andmed=andmed[andmed$ministeerium_en==minist,]\n    } else if (minJah==2) {\n      andmed=andmed\n    }else {\n      #andmed=andmed[andmed$allasutus_en==allasutus,]\n      andmed=andmed[allasutus_en==allasutusnimi]\n    }\n    valueBox(\n      paste(round(\n        mean(\n          andmed[andmed$naitaja==\"rahulolu\",]$value, na.rm = T), 1)) \n      ,paste(\"%\", text),icon = icon(\"smile-o\"),color = \"purple\")\n  }\n}\n\n##asutuste/minni teenuse kogukulu arvutamiseks, teeb valueboxi interface\nHalduskuluSum=function(andmed, minist, allasutusnimi, minJah, text, keel) {\n  if (keel==\"et\") {\n    if (minJah==1) { #kui muu, siis on allasutus\n      andmed=andmed[andmed$ministeerium==minist,]\n    } else if (minJah==2) {\n      andmed=andmed\n    }else {\n      #andmed=andmed[andmed$allasutus==allasutus,]\n      andmed=andmed[allasutus==allasutusnimi]\n    }\n    valueBox(\n      paste(\n        format(round(\n          sum(andmed[andmed$naitaja==\"halduskulu\",]$value, na.rm = T)), big.mark=\" \")), \n      text,icon = icon(\"euro\"),color = \"purple\")\n  } else {\n    if (minJah==1) { #kui muu, siis on allasutus\n      andmed=andmed[andmed$ministeerium_en==minist,]\n    } else if (minJah==2) {\n      andmed=andmed\n    }else {\n      #andmed=andmed[andmed$allasutus_en==allasutus,]\n      andmed=andmed[allasutus_en==allasutusnimi]\n    }\n    valueBox(\n      paste(\n        format(round(\n          sum(andmed[andmed$naitaja==\"halduskulu\",]$value, na.rm = T)), big.mark=\" \")), \n      text,icon = icon(\"euro\"),color = \"purple\")\n  }\n}\n\n#asutuste/minni klientide ajakulu kokku arvutamiseks, teeb kohe\n#valueboxi interface\nKliendiAjakuluSum=function(andmed, minist, allasutusnimi, minJah, text, keel) {\n  if (keel==\"et\") {\n    if (minJah==1) { #kui muu, siis on allasutus\n      andmed=andmed[andmed$ministeerium==minist,]\n    } else if (minJah==2) {\n      andmed=andmed\n    }else {\n      #andmed=andmed[andmed$allasutus==allasutus,]\n      andmed=andmed[allasutus==allasutusnimi]\n    }\n    osutamistearv=andmed[andmed$naitaja==\"osutamiste arv\",]$value\n    ajakulu=andmed[andmed$naitaja==\"ajakulu\",]$value\n    valueBox(\n      paste(paste(format(round(sum(ajakulu*osutamistearv ,na.rm=T)), big.mark=\" \"))), \n      text,icon = icon(\"clock-o\"),color = \"purple\")\n  } else {\n    if (minJah==1) { #kui muu, siis on allasutus\n      andmed=andmed[andmed$ministeerium_en==minist,]\n    } else if (minJah==2) {\n      andmed=andmed\n    }else {\n      #andmed=andmed[andmed$allasutus==allasutus,]\n      andmed=andmed[allasutus_en==allasutusnimi]\n    }\n    osutamistearv=andmed[andmed$naitaja==\"osutamiste arv\",]$value\n    ajakulu=andmed[andmed$naitaja==\"ajakulu\",]$value\n    valueBox(\n      paste(paste(format(round(sum(ajakulu*osutamistearv ,na.rm=T)), big.mark=\" \"))), \n      text,icon = icon(\"clock-o\"),color = \"purple\")\n  }\n  \n}\n",
    "created" : 1459515824097.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1457382852",
    "id" : "8B834B22",
    "lastKnownWriteTime" : 1459961161,
    "path" : "~/R/Riigiteenused_shinyApp/helpers.R",
    "project_path" : "helpers.R",
    "properties" : {
    },
    "relative_order" : 3,
    "source_on_save" : false,
    "type" : "r_source"
}